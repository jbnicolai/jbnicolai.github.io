<!DOCTYPE html><html><head><meta http-equiv=Content-Type content=text/html charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>JBNicolai - PhantomJS data mining</title><meta name=description content=""><meta name=HandheldFriendly content=True><meta name=MobileOptimized content=320><meta name=viewport content="width=device-width, initial-scale=1.0"><meta name=twitter:card content=summary><meta name=twitter:title content="PhantomJS data mining"><meta name=twitter:description content="&lt;p&gt;As a moderately large company we rent mail boxes for our employees at a hosting provider; a lot of mailboxes. These come in varying sizes, and naturally the larger you go the more expensive they become.&lt;/p&gt;

&lt;p&gt;The other day I received an email requesting several new accounts and set upon creating these when I came across what seemed to be a rather inefficient allocation. The user had a mid-size tier, costing about €150 per year, while he could seemingly make do with the very smallest tier of about €50 annually.&lt;/p&gt;

&lt;p&gt;This, of course, made me curious about our other allocations and I went looking for an overview of all our mail accounts&amp;#39; usage. No such luck. The only way to see how much of the rented space was actually being used was by navigating the - non-rest and stateful - web interface of our hosting provider and looking up the statistics for each user individually.&lt;/p&gt;

&lt;p&gt;Challenge accepted!&lt;/p&gt;
"><meta name=twitter:creator content=@BoyNicolai><meta name=twitter:image content=""><meta name=twitter:url content=http://jbnicolai.com/2014/02/11/phantomjs-data-mining.html><meta name=twitter:domain content=http://jbnicolai.com><link rel=author href="https://plus.google.com/+JoshuaAppelman?rel=author"><link rel=stylesheet href=/css/main.c6e5.css><link rel=stylesheet type=text/css href=//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css><link rel=stylesheet type=text/css href="//fonts.googleapis.com/css?family=Droid+Serif"><link rel=stylesheet type=text/css href="//fonts.googleapis.com/css?family=Open+Sans:600,300"><link rel=apple-touch-icon-precomposed sizes=152x152 href=/img/icons/apple-touch-icon-152x152-precomposed.png><link rel=apple-touch-icon-precomposed sizes=120x120 href=/img/icons/apple-touch-icon-120x120-precomposed.png><link rel=apple-touch-icon-precomposed sizes=76x76 href=/img/icons/apple-touch-icon-76x76-precomposed.png><link rel=apple-touch-icon-precomposed sizes=60x60 href=/img/icons/apple-touch-icon-60x60-precomposed.png><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/icons/apple-touch-icon-144x144-precomposed.png><link rel=apple-touch-icon-precomposed sizes=114x114 href=/img/icons/apple-touch-icon-114x114-precomposed.png><link rel=apple-touch-icon-precomposed sizes=72x72 href=/img/icons/apple-touch-icon-72x72-precomposed.png><link rel=apple-touch-icon sizes=57x57 href=/img/icons/apple-touch-icon.png><link rel="shortcut icon" href=/img/icons/favicon.ico><link rel=icon type=image/png sizes=64x64 href=/img/icons/favicon.png></head><body><header class="site_width text center padding_top_big margin_bottom_big"><h1 class="blog_title margin_bottom_small"><a href="/">Joshua Boy Nicolai</a></h1><h4 class="text book">Musings</h4><div class="social border solid top_small bottom_small padding_medium"><h6 class="text book color c_black_medium without_margin padding_right_big"><a href=/about><i class="fa fa-user"></i> <span class="margin_left_small desktop">About me</span></a></h6><h6 class="text book color c_black_medium without_margin padding_right_big"><a href=//linkedin.com/in/jbnicolai target=_blank><i class="fa fa-linkedin-square"></i> <span class="margin_left_small desktop">LinkedIn</span></a></h6><h6 class="text book color c_black_medium without_margin padding_right_big"><a href=//twitter.com/BoyNicolai target=_blank><i class="fa fa-twitter-square"></i> <span class="margin_left_small desktop">Twitter</span></a></h6><h6 class="text book color c_black_medium without_margin"><a href=//github.com/jbnicolai target=_blank><i class="fa fa-github"></i> <span class="margin_left_small desktop">GitHub</span></a></h6></div></header><main class=site_width role=main><header class="text center margin_bottom_medium"><h1 class=margin_bottom_medium>PhantomJS data mining</h1><h5 class="text book small uppercase color c_black_light margin_bottom_small"><time datetime="Tue, 11 Feb 2014 00:00:00 +0100">11 February 2014</time></h5></header><section><p>As a moderately large company we rent mail boxes for our employees at a hosting provider; a lot of mailboxes. These come in varying sizes, and naturally the larger you go the more expensive they become.</p><p>The other day I received an email requesting several new accounts and set upon creating these when I came across what seemed to be a rather inefficient allocation. The user had a mid-size tier, costing about €150 per year, while he could seemingly make do with the very smallest tier of about €50 annually.</p><p>This, of course, made me curious about our other allocations and I went looking for an overview of all our mail accounts&#39; usage. No such luck. The only way to see how much of the rented space was actually being used was by navigating the - non-rest and stateful - web interface of our hosting provider and looking up the statistics for each user individually.</p><p>Challenge accepted!</p><!--more--><p>I&#39;ve gotten tired of using <a href="http://docs.seleniumhq.org/">selenium</a> lately, and been meaning to look into some of <a href="http://phantomjs.org/">PhantomJS</a> based alternatives. My eye had fallen on <a href="http://casperjs.org/">CasperJS</a> and I decided to give it a spin.</p><p>Using <a href="http://brew.sh/">brew</a> I downloaded the latest development release:</p><div class=highlight><pre><code class=bash><span class=nv>$ </span>brew update
<span class=nv>$ </span>brew install casperjs --devel
</code></pre></div><p>The script in it&#39;s entirety can be found in this <a href=https://gist.github.com/jbnicolai/8923825>gist</a>, but walking per section:</p><div class=highlight><pre><code class=js><span class=kd>var</span> <span class=nx>casper</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;casper&#39;</span><span class=p>).</span><span class=nx>create</span><span class=p>({</span> <span class=nx>verbose</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span> <span class=nx>logLevel</span><span class=o>:</span> <span class=s1>&#39;info&#39;</span> <span class=p>});</span>
<span class=kd>var</span> <span class=nx>credentials</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>).</span><span class=nx>read</span><span class=p>(</span><span class=s1>&#39;./credentials.json&#39;</span><span class=p>));</span>
<span class=kd>var</span> <span class=nx>url</span> <span class=o>=</span> <span class=s1>&#39;private&#39;</span><span class=p>;</span>

<span class=nx>casper</span><span class=p>.</span><span class=nx>start</span><span class=p>(</span><span class=nx>url</span> <span class=o>+</span> <span class=s1>&#39;/user/login&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>this</span><span class=p>.</span><span class=nx>fill</span><span class=p>(</span><span class=s1>&#39;form#login_form&#39;</span><span class=p>,</span> <span class=nx>credentials</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
 <span class=p>});</span>
</code></pre></div><p>The first line initialises CasperJS, with some logging enabled. The second line reads in a simple json file containing the form fields and values of the login page, while the third line contains the base url of our hosting provider.</p><p>In the next section casper is told to navigate to said url&#39;s login page, fill in the specified form with the credentials and submit. It&#39;s that easy!</p><div class=highlight><pre><code class=js><span class=nx>casper</span><span class=p>.</span><span class=nx>thenOpen</span><span class=p>(</span><span class=nx>url</span><span class=o>+</span><span class=s1>&#39;/subscription/config/xebia.com/exchange_mailbox&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
<span class=err>  </span><span class=k>this</span><span class=p>.</span><span class=nx>getElementsInfo</span><span class=p>(</span><span class=s1>&#39;tr td  a&#39;</span><span class=p>).</span><span class=nx>forEach</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>node</span><span class=p>)</span> <span class=p>{</span>
<span class=err>    </span><span class=k>if</span> <span class=p>(</span><span class=nx>node</span><span class=p>.</span><span class=nx>attributes</span><span class=p>.</span><span class=nx>nicetitle</span> <span class=o>===</span> <span class=s2>&quot;View&quot;</span><span class=p>)</span> <span class=p>{</span>
</code></pre></div><p>All logged in, it&#39;s time to navigate to the exchange&#39;s overview page. Here every user&#39;s account details are linked to, in a node with the attribute nicetitle=&quot;view&quot;. Naturally, we want to iterate over these. This is where a small hitch in the plan was encountered.. the html is completely unstructured. Simply a table of varying dimensions with label, value pairs. I decide to postpone the problem, and for now simply fetch the entire element:</p><div class=highlight><pre><code class=js><span class=nx>casper</span><span class=p>.</span><span class=nx>thenOpen</span><span class=p>(</span><span class=nx>url</span> <span class=o>+</span> <span class=nx>node</span><span class=p>.</span><span class=nx>attributes</span><span class=p>.</span><span class=nx>href</span><span class=p>,</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
  <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>).</span><span class=nx>write</span><span class=p>(</span><span class=s1>&#39;output&#39;</span><span class=p>,</span>
    <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>getElementInfo</span><span class=p>(</span><span class=s1>&#39;div.contentleft&#39;</span><span class=p>).</span><span class=nx>html</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span><span class=p>));</span>
<span class=p>});</span>
</code></pre></div><p>Ending it all with a:</p><div class=highlight><pre><code class=js><span class=nx>casper</span><span class=p>.</span><span class=nx>run</span><span class=p>();</span>
</code></pre></div><p>It&#39;s time to dive in to the console and give it a spin:</p><div class=highlight><pre><code class=bash><span class=nv>$ </span>casperjs fetch.js
</code></pre></div><p>Excellent! Casper is spinning along, discovering and fetching the data, and I can see a tail of the generated output file streaming in. Unreadable, but the data is all there. See part two for the data analysis using BASH.</p></section><footer><section class="author_info margin_top_big"><div class="alignleft border rad_circle" style="height: 87px; width: 87px; background-image: url(https://secure.gravatar.com/avatar/49b172b279ea0ff79adfad475a45a701.png); background-size: cover"></div><p class="margin_left_medium text small">Author</p><p class="margin_left_medium text bold"><a href="">Joshua Boy Nicolai</a></p><p class="margin_left_medium text small"></p></section></footer></main><footer class="blog_info margin_top_big padding_medium text center"><h5 class="text book small">Browse the source at <a href=https://github.com/jbnicolai/jbnicolai.com><span>GitHub</span></a></h5></footer><!--[> build:js(app) /js/scripts.js <]--><script src=/js/main.js></script><!--[> endbuild <]--></body></html>